---
  title: npm run serve çš„æ—…é€”é£æ™¯
  authors:
    name: qwer_abc
    title: ä¸å­¦ä¹ æ˜¯æ²¡æœ‰é’±é€”çš„ï¼
    url: https://juejin.cn/user/897675666396296
    image_url: https://p3-passport.byteacctimg.com/img/user-avatar/25e21462cc5ec6a3dbaf10570b604e5b~300x300.image
  tags: [npm, vue-cli-service]
---

## è¾“å…¥ npm run ... ååšäº†ä»€ä¹ˆï¼Ÿ

`node_modules\@vue\cli-service`ğŸ¤–

**npm run serve**ï¼Œå…¶ä¸­è¿™ä¸ª serve çš„å†…å®¹å°±æ˜¯`vue-cli-service serve`

`"serve": "vue-cli-service serve"`

### vue-cli-service.js

npm çš„è¯­ä¹‰ç‰ˆæœ¬å™¨

```js
const semver = require('semver');
```

vue-cli çš„å…±äº«å·¥å…·

```js
const { error,... } = require('@vue/cli-shared-utils')
```

```js
const semver = require('semver');
const { error } = require('@vue/cli-shared-utils');
const requiredVersion = require('../package.json').engines.node;

// æ£€æµ‹nodeç‰ˆæœ¬æ˜¯å¦ç¬¦åˆvue-cliè¿è¡Œçš„éœ€æ±‚ã€‚ä¸ç¬¦åˆåˆ™æ‰“å°é”™è¯¯å¹¶é€€å‡ºã€‚
if (!semver.satisfies(process.version, requiredVersion)) {
  error(
    `You are using Node ${process.version}, but vue-cli-service ` +
      `requires Node ${requiredVersion}.\nPlease upgrade your Node version.`
  );
  process.exit(1);
}
```

cli-service çš„æ ¸å¿ƒç±»

`node_modules\@vue\cli-service\lib\Service.js`

```js
const Service = require('../lib/Service');
// æ–°å»ºä¸€ä¸ªserviceçš„å®ä¾‹ã€‚å¹¶ä¼ å…¥å½“å‰é¡¹ç›®æ ¹è·¯å¾„ã€‚process.cwd()çš„ç»“æœä¸€èˆ¬æ˜¯å½“å‰é¡¹ç›®æ ¹è·¯å¾„
const service = new Service(process.env.VUE_CLI_CONTEXT || process.cwd());
```

å‚æ•°å¤„ç†

`"vue-cli-service serve"`

è§£æå‚æ•°é€‰é¡¹ `require('minimist')`

```js
const rawArgv = process.argv.slice(2); // [ 'serve' ]ğŸ“
const args = require('minimist')(rawArgv, {
  boolean: [
    // build
    'modern',
    'report',
    'report-json',
    'watch',
    // serve
    'open',
    'copy',
    'https',
    // inspect
    'verbose',
  ],
});
/*ğŸ“
{
  _: [ 'serve' ],
  modern: false,
  report: false,
  'report-json': false,
  'inline-vue': false,
  watch: false,
  open: false,
  copy: false,
  https: false,
  verbose: false
}
 */
const command = args._[0]; // serveğŸ“
console.log(
  process.argv
) // ['node.exe ç¨‹åºç»å¯¹è·¯å¾„','vue-cli-service.js ç»å¯¹è·¯å¾„'ï¼Œ'serve']ğŸ“
`npm run serve https`; // ['node.exeç¨‹åºç»å¯¹è·¯å¾„','vue-cli-service.jsç»å¯¹è·¯å¾„'ï¼Œ'serve'ï¼Œ'httpa']ğŸ“
```

`service.run('serve',{...args},['serve','https',...])`

```js
// å°†å‚æ•°ä¼ å…¥serviceè¿™ä¸ªå®ä¾‹å¹¶å¯åŠ¨åç»­å·¥ä½œã€‚å¦‚æœæˆ‘ä»¬è¿è¡Œçš„æ˜¯npm run serveã€‚åˆ™command = "serve"ã€‚
service.run(command, args, rawArgv).catch(err => {
  error(err);
  process.exit(1);
});
```

ä¸Šé¢çš„ä»£ç æœ€åè°ƒç”¨ `node_modules\@vue\cli-service\lib\Service.js` ä¸­çš„ `run` æ¥è¿›è¡Œé¡¹ç›®çš„æ„å»º ğŸ“

### Service.js

```js
// fsæ˜¯filesystemçš„ç¼©å†™ï¼Œè¯¥æ¨¡å—æä¾›æœ¬åœ°æ–‡ä»¶çš„è¯»å†™èƒ½åŠ›ğŸ“
const fs = require('fs');
// pathæ¨¡å—æ˜¯Node.jså®˜æ–¹æä¾›çš„ã€ç”¨æ¥å¤„ç†è·¯å¾„çš„æ¨¡å—ğŸ“
const path = require('path');
// JavaScript è°ƒè¯•å®ç”¨ç¨‹åºã€‚é€‚ç”¨äº Node.js å’Œ Web æµè§ˆå™¨ğŸ“
const debug = require('debug');
// ä¿®é¥°è¾“å‡ºæ§åˆ¶å°å†…å®¹çš„æ–‡å­—æ ·å¼ğŸ“
const chalk = require('chalk');
// è¯»å– package.json æ–‡ä»¶ğŸ“
const readPkg = require('read-pkg');
// åˆå¹¶ webpack é…ç½®,é€šå¸¸ä¼šæŠŠå¼€å‘ã€ç”Ÿäº§æ–‡ä»¶åˆ†å¼€é…ç½®,å†è¿›è¡Œä¸å…±åŒé…ç½®æ–‡ä»¶åˆå¹¶ğŸ“
const merge = require('webpack-merge');
// è¯¦æƒ…è§ä¸‹æ–‡ğŸ“Œ
const Config = require('webpack-chain');
// ä¸»è¦æ˜¯è¿æ¥ plugin çš„æ³¨å†Œå’Œserviceå®ä¾‹ğŸ“
const PluginAPI = require('./PluginAPI');
// .envæ–‡ä»¶ä¸­çš„é…ç½®ğŸ“
const loadEnv = require('./util/loadEnv');
// defaultsDeep()æ–¹æ³•é€’å½’åœ°åˆ†é…`é»˜è®¤å±æ€§`ğŸ“
const defaultsDeep = require('lodash.defaultsdeep');
// Vue çš„å…±äº«å·¥å…·
const { warn, error, isPlugin, loadModule } = require('@vue/cli-shared-utils');

const { defaults, validate } = require('./options');
```

```js
const Config = require('webpack-chain');
```

webpack çš„æ ¸å¿ƒé…ç½®çš„åˆ›å»ºå’Œä¿®æ”¹åŸºäºä¸€ä¸ªæœ‰æ½œåœ¨éš¾äºå¤„ç†çš„ JavaScript å¯¹è±¡ã€‚è™½ç„¶è¿™å¯¹äºé…ç½®å•ä¸ªé¡¹ç›®æ¥è¯´è¿˜æ˜¯ OK çš„ï¼Œä½†å½“ä½ å°è¯•è·¨é¡¹ç›®å…±äº«è¿™äº›å¯¹è±¡å¹¶ä½¿å…¶è¿›è¡Œåç»­çš„ä¿®æ”¹å°±ä¼šå˜çš„æ··ä¹±ä¸å ªï¼Œå› ä¸ºæ‚¨éœ€è¦æ·±å…¥äº†è§£åº•å±‚å¯¹è±¡çš„ç»“æ„ä»¥è¿›è¡Œè¿™äº›æ›´æ”¹ã€‚

`webpack-chain` å°è¯•é€šè¿‡æä¾›å¯é“¾å¼æˆ–é¡ºæµå¼çš„ API åˆ›å»ºå’Œä¿®æ”¹ webpack é…ç½®ã€‚API çš„ Key éƒ¨åˆ†å¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šçš„åç§°å¼•ç”¨ï¼Œè¿™æœ‰åŠ©äº è·¨é¡¹ç›®ä¿®æ”¹é…ç½®æ–¹å¼ çš„æ ‡å‡†åŒ–ã€‚ğŸ“

### Service ç±»æ ¸å¿ƒä»£ç 

```js
module.exports = class Service {
  constructor (context, { plugins, pkg, inlineOptions, useBuiltIn } = {}) {
    // å°†å®ä¾‹åŒ–çš„å¯¹è±¡å­˜å‚¨åˆ°å…¨å±€å˜é‡ process.VUE_CLI_SERVICEğŸ“
    process.VUE_CLI_SERVICE = this
    this.initialized = false
    // ä¸€èˆ¬æ˜¯å½“å‰é¡¹ç›®æ ¹ç›®å½•è·¯å¾„ã€‚
    this.context = context
    this.inlineOptions = inlineOptions
    // webpackç›¸å…³æ”¶é›†ã€‚ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ã€‚æ‰€ä»¥æœªåˆ—å‡ºè¯¥æ–¹æ³•å®ç°
    this.webpackChainFns = []
    this.webpackRawConfigFns = []
    this.devServerConfigFns = []
    //å­˜å‚¨çš„å‘½ä»¤,è°ƒç”¨ run æ—¶ä¼šä¼ è¿›æ¥ğŸ“
    this.commands = {}
    // Folder containing the target package.json for plugins
    this.pkgContext = context
    // é”®å€¼å¯¹å­˜å‚¨çš„pakcage.jsonå¯¹è±¡ï¼Œä¸æ˜¯æœ¬æ–‡é‡ç‚¹ã€‚æ‰€ä»¥æœªåˆ—å‡ºè¯¥æ–¹æ³•å®ç°
    this.pkg = this.resolvePkg(pkg)
    // è¿™ä¸ªæ–¹æ³•ä¸‹æ–¹éœ€è¦é‡ç‚¹é˜…è¯»ğŸ§©
    this.plugins = this.resolvePlugins(plugins, useBuiltIn)

    // ç»“æœä¸º{build: production, serve: development, ... },å¤§æ„æ˜¯æ”¶é›†æ’ä»¶ä¸­çš„é»˜è®¤é…ç½®ä¿¡æ¯
    // æ ‡æ³¨buildå‘½ä»¤ä¸»è¦ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚
    this.modes = this.plugins.reduce((modes, { apply: { defaultModes }}) => {
      return Object.assign(modes, defaultModes)
    }, {})
  }

  init (mode = process.env.VUE_CLI_MODE) {
      // æ˜¯å¦åˆå§‹åŒ–ğŸ“
      if (this.initialized) {
      return
    }
    this.initialized = true
    this.mode = mode

    // åŠ è½½.envæ–‡ä»¶ä¸­çš„é…ç½®
    if (mode) {
      this.loadEnv(mode)
    }
    // load base .env
    this.loadEnv()

------------------------------------------------------------------------------------------------
    // è¯»å–ç”¨æˆ·çš„é…ç½®ä¿¡æ¯.ä¸€èˆ¬ä¸ºvue.config.js
    const userOptions = this.loadUserOptions()
    // è¯»å–é¡¹ç›®çš„é…ç½®ä¿¡æ¯å¹¶ä¸ç”¨æˆ·çš„é…ç½®åˆå¹¶(ç”¨æˆ·çš„ä¼˜å…ˆçº§é«˜ğŸ“Œ)
    this.projectOptions = defaultsDeep(userOptions, defaults())

    debug('vue:project-config')(this.projectOptions)
------------------------------------------------------------------------------------------------
    // æ³¨å†Œæ’ä»¶ğŸ§©
    this.plugins.forEach(({ id, apply }) => {
      apply(new PluginAPI(id, this), this.projectOptions)
    })

    // wepbackç›¸å…³é…ç½®æ”¶é›†
    if (this.projectOptions.chainWebpack) {
      this.webpackChainFns.push(this.projectOptions.chainWebpack)
    }
    if (this.projectOptions.configureWebpack) {
      this.webpackRawConfigFns.push(this.projectOptions.configureWebpack)
    }
  }

-2022-05-03 æœªè¯»
  resolvePlugins (inlinePlugins, useBuiltIn) {
    const idToPlugin = id => ({
      id: id.replace(/^.\//, 'built-in:'),
      apply: require(id)
    })

    let plugins


    // ä¸»è¦æ˜¯è¿™é‡Œã€‚mapå¾—åˆ°çš„æ¯ä¸ªæ’ä»¶éƒ½æ˜¯ä¸€ä¸ª{id, applyçš„å½¢å¼}
    // å…¶ä¸­require(id)å°†ç›´æ¥importæ¯ä¸ªæ’ä»¶çš„é»˜è®¤å¯¼å‡ºã€‚
    // æ¯ä¸ªæ’ä»¶çš„å¯¼å‡ºapiä¸º
    // module.exports = (PluginAPIInstance,projectOptions) => {
    //    PluginAPIInstance.registerCommand('cmdNameï¼ˆä¾‹å¦‚npm run serveä¸­çš„serveï¼‰', args => {
    //        // æ ¹æ®å‘½ä»¤è¡Œæ”¶åˆ°çš„å‚æ•°ï¼Œæ‰§è¡Œè¯¥æ’ä»¶çš„ä¸šåŠ¡é€»è¾‘
    //    })
    //    //  ä¸šåŠ¡é€»è¾‘éœ€è¦çš„å…¶ä»–å‡½æ•°
    //}
    // æ³¨æ„è¿™é‡Œæ˜¯å…ˆåœ¨æ„é€ å‡½æ•°ä¸­resolveäº†æ’ä»¶ã€‚ç„¶åå†run->init->æ–¹æ³•ä¸­å°†å‘½ä»¤ï¼Œé€šè¿‡è¿™é‡Œçš„çš„applyæ–¹æ³•ï¼Œ
    // å°†æ’ä»¶å¯¹åº”çš„å‘½ä»¤æ³¨å†Œåˆ°äº†serviceå®ä¾‹ã€‚
    const builtInPlugins = [
      './commands/serve',
      './commands/build',
      './commands/inspect',
      './commands/help',
      // config plugins are order sensitive
      './config/base',
      './config/css',
      './config/dev',
      './config/prod',
      './config/app'
    ].map(idToPlugin)

    // inlinePluginsä¸éinlineå¾—å¤„ç†ã€‚é»˜è®¤ç”Ÿæˆçš„é¡¹ç›®ç›´æ¥è¿è¡Œæ—¶å€™ï¼Œé™¤äº†ä¸Šè¿°æ•°ç»„çš„æ’ä»¶['./commands/serve'...]å¤–ï¼Œè¿˜ä¼šæœ‰
    // ['@vue/cli-plugin-babel','@vue/cli-plugin-eslint','@vue/cli-service']ã€‚
    // å¤„ç†ç»“æœæ˜¯ä¸¤è€…çš„åˆå¹¶ï¼Œç»†èŠ‚çœç•¥ã€‚
    if (inlinePlugins) {
        //...
    } else {
        //...é»˜è®¤èµ°è¿™æ¡è·¯çº¿
      plugins = builtInPlugins.concat(projectPlugins)
    }

    // Local plugins å¤„ç†package.jsonä¸­å¼•å…¥æ’ä»¶çš„å½¢å¼ï¼Œå…·ä½“ä»£ç çœç•¥ã€‚

    return plugins
  }

  async run (name, args = {}, rawArgv = []) {
    // modeæ˜¯devè¿˜æ˜¯prodï¼Ÿ
    const mode = args.mode || (name === 'build' && args.watch ? 'development' : this.modes[name])

    // æ”¶é›†ç¯å¢ƒå˜é‡ã€æ’ä»¶ã€ç”¨æˆ·é…ç½®
    this.init(mode)

    args._ = args._ || []
    let command = this.commands[name]
    if (!command && name) {
      error(`command "${name}" does not exist.`)
      process.exit(1)
    }
    if (!command || args.help) {
      command = this.commands.help
    } else {
      args._.shift() // remove command itself
      rawArgv.shift()
    }
    // æ‰§è¡Œå‘½ä»¤ã€‚ä¾‹å¦‚vue-cli-service serve åˆ™ï¼Œæ‰§è¡Œserveå‘½ä»¤ã€‚
    const { fn } = command
    return fn(args, rawArgv)
  }

  // æ”¶é›†vue.config.jsä¸­çš„ç”¨æˆ·é…ç½®ã€‚å¹¶ä»¥å¯¹è±¡å½¢å¼è¿”å›ã€‚
  loadUserOptions () {
    // æ­¤å¤„ä»£ç çœç•¥ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º
    // require(vue.config.js)
    return resolved
  }
}
```

**service å®ä¾‹åŒ–å ğŸ“Œï¼š**

![](https://raw.githubusercontent.com/Kiyan-a/For_picGo/img/202205032235623.png)

### core.js

1.core-js å®ƒæ˜¯ JavaScript æ ‡å‡†åº“çš„ polyfillï¼ˆå«ç‰‡/è¡¥ä¸ï¼‰, æ–°åŠŸèƒ½çš„ es'api'è½¬æ¢ä¸ºå¤§éƒ¨åˆ†ç°ä»£æµè§ˆå™¨éƒ½å¯ä»¥æ”¯æŒ
è¿è¡Œçš„ä¸€ä¸ª'api' è¡¥ä¸åŒ…é›†åˆã€‚è®©æˆ‘ä»¬åœ¨ä¸å…¼å®¹æŸäº›æ–°ç‰¹æ€§çš„æµè§ˆå™¨ä¸Šï¼Œä½¿ç”¨è¯¥æ–°ç‰¹æ€§ã€‚ 2.å› ä¸ºå®˜æ–¹åº“å¯¹ä»–ä»‹ç»çš„å½¢å®¹
2.1.å®ƒæ”¯æŒæœ€æ–°çš„ ECMAScript æ ‡å‡†
2.2.å®ƒæ”¯æŒ ECMAScript æ ‡å‡†åº“ææ¡ˆ
2.3.å®ƒæ”¯æŒä¸€äº› WHATWG / W3C æ ‡å‡†ï¼ˆè·¨å¹³å°æˆ–è€… ECMAScript ç›¸å…³ï¼‰
2.4.å®ƒæœ€å¤§é™åº¦çš„æ¨¡å—åŒ–ï¼šä½ èƒ½ä»…ä»…åŠ è½½ä½ æƒ³è¦ä½¿ç”¨çš„åŠŸèƒ½
2.5.å®ƒèƒ½å¤Ÿä¸æ±¡æŸ“å…¨å±€å‘½åç©ºé—´
2.6.å®ƒå’Œ babel ç´§å¯†é›†æˆï¼šè¿™èƒ½å¤Ÿä¼˜åŒ– core-js çš„å¯¼å…¥
2.7.å®ƒæ˜¯æœ€æ™®éã€æœ€æµè¡Œ çš„ç»™ JavaScript æ ‡å‡†åº“æ‰“è¡¥ä¸çš„æ–¹å¼

![](https://raw.githubusercontent.com/Kiyan-a/For_picGo/img/202205032111820.png)
